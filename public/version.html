<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="version" content="<%= ENV.VUE_APP_VERSION %>">
  <title>Endpass Version</title>
</head>
<body>
<noscript>
  <strong
  >We're sorry but endpass-auth doesn't work properly without
    JavaScript enabled. Please enable it to continue.</strong
  >
</noscript>
<script>
  (() => {
    const getProps = () => {
      const checkString = window.location.search.replace('?', '');
      return checkString.split(';').reduce((resultProps, strBlock) => {
        const blockValues = strBlock.split('=');
        return {
          ...resultProps,
          [blockValues[0]]: blockValues[1],
        }
      }, {});
    };

    const getVersion = () => {
      const metaVersion = document.querySelector('meta[name="version"]');
      const version = metaVersion.getAttribute('content') || '';
      return version;
    };

    const getOriginByVersion = (version, passedProps) => {
      const isNeedReplaceOrigin = window.location.href.indexOf('://auth') !== -1;
      const origin = window.location.origin;

      if (!isNeedReplaceOrigin) {
        return origin;
      }

      const isSameVersion = version.indexOf(passedProps.v) === 0;
      if (isSameVersion) {
        return origin;
      }

      const routeVersion = passedProps.v.split('.').join('-');
      const originWithVersion = origin.replace('://auth', '://auth' + routeVersion);
      return originWithVersion;
    };

    const props = getProps();
    const version = getVersion();

    const newUrl = getOriginByVersion(version, props) + props.redirect;

    // props format is like ?v=1.2;redirect=/bridge

    window.location.href = newUrl;
  })();

</script>
</body>
</html>
